name: Neon Migration Preview Branch

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - closed
    paths:
      - "apps/api/prisma/migrations/**"
  workflow_dispatch:

concurrency:
  group: neon-migration-preview-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  create-neon-branch:
    name: Create Neon Branch for Migration PR
    if: ${{ github.event.action != 'closed' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
    # Secrets are not available for fork PRs. Skip instead of failing.
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Validate Neon configuration
        env:
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ -z "$NEON_PROJECT_ID" ]; then
            echo "Missing repository variable: NEON_PROJECT_ID"
            exit 1
          fi
          if [ -z "$NEON_API_KEY" ]; then
            echo "Missing repository secret: NEON_API_KEY"
            exit 1
          fi

      - name: Derive Neon branch name
        id: naming
        run: |
          echo "branch_name=preview/pr-${{ github.event.pull_request.number || github.run_number }}" >> "$GITHUB_OUTPUT"

      - name: Create (or reuse) Neon branch
        id: create-branch
        uses: neondatabase/create-branch-action@v6
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.naming.outputs.branch_name }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Write workflow summary
        run: |
          echo "### Neon preview branch created for migration PR" >> "$GITHUB_STEP_SUMMARY"
          echo "- Neon branch: \`${{ steps.naming.outputs.branch_name }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Created now: \`${{ steps.create-branch.outputs.created }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Branch ID: \`${{ steps.create-branch.outputs.branch_id }}\`" >> "$GITHUB_STEP_SUMMARY"

  cleanup-neon-branch:
    name: Cleanup Neon Branch on PR Close
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Validate Neon configuration
        env:
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ -z "$NEON_PROJECT_ID" ]; then
            echo "Missing repository variable: NEON_PROJECT_ID"
            exit 1
          fi
          if [ -z "$NEON_API_KEY" ]; then
            echo "Missing repository secret: NEON_API_KEY"
            exit 1
          fi

      - name: Derive Neon branch name
        id: naming
        run: |
          echo "branch_name=preview/pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"

      - name: Find Neon branch ID
        id: find-branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
          BRANCH_NAME: ${{ steps.naming.outputs.branch_name }}
        run: |
          BRANCH_ID=$(curl -fsSL \
            -H "Authorization: Bearer ${NEON_API_KEY}" \
            "https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches" \
            | jq -r --arg name "${BRANCH_NAME}" '.branches[] | select(.name == $name) | .id' \
            | head -n 1)

          if [ -z "${BRANCH_ID}" ] || [ "${BRANCH_ID}" = "null" ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "branch_id=${BRANCH_ID}" >> "$GITHUB_OUTPUT"

      - name: Delete Neon branch
        if: ${{ steps.find-branch.outputs.found == 'true' }}
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
          BRANCH_ID: ${{ steps.find-branch.outputs.branch_id }}
        run: |
          curl -fsSL -X DELETE \
            -H "Authorization: Bearer ${NEON_API_KEY}" \
            "https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches/${BRANCH_ID}" >/dev/null

      - name: Write cleanup summary
        run: |
          echo "### Neon preview branch cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "- Neon branch: \`${{ steps.naming.outputs.branch_name }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.find-branch.outputs.found }}" = "true" ]; then
            echo "- Deleted branch ID: \`${{ steps.find-branch.outputs.branch_id }}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- No matching branch found; nothing to delete" >> "$GITHUB_STEP_SUMMARY"
          fi
